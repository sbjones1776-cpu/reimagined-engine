import{R as V,S as $,a2 as Y,G as x,x as e,d as j,l as _,C as f,W as y,M as N,U as v,_ as g,v as F,n as B,s as W,L as K,r as R,h as U,m as X,a4 as H,X as L,aV as z,aa as Z,aQ as J,a0 as ee,Z as ae,ad as se}from"./index-DS6ADruV.js";import{I as E}from"./useMutation-Dw-sPjxD-CEUn9Yuu-xvhDPSZb-Dr0QtMK_-BVesU6qw-CG5MCbzm-BvDHL4Y4-BLMKEBwG.js";import{H as le}from"./progress-DswiN-jt-CRkTvpyk-D1KYlrjl-CsboKJzw-C3ozQzG_-BS-NPxbZ-Do7G8zpZ-Cj6Z1Ic1.js";import{p as te}from"./trending-up-DOxCo9I6-CjyZKRpy-BwiJPOic-BbyIY-I5-2slMDHp0-Dt8Hz_gu-DQ4ciPVI-C7q_24xj.js";import{y as re}from"./target-1p2ICMDN-CvDzxGjB-qkOcir94-HosS9mN8-D7ZLtM3Q-fUNOd4Tb-uVCUCnov-BMauAVDu.js";function oe(){const w=V(),[C,k]=$.useState(null),{user:s}=Y(),{data:G=[]}=x({queryKey:["allUsers"],queryFn:()=>J(),staleTime:3e5}),{data:o=[]}=x({queryKey:["myTeamChallenges",s==null?void 0:s.email],queryFn:()=>ee(s.email),enabled:!!(s!=null&&s.email)}),{data:q=[]}=x({queryKey:["myProgress",s==null?void 0:s.email],queryFn:()=>ae(s.email),enabled:!!(s!=null&&s.email)}),{data:M=[]}=x({queryKey:["myDailyChallenges",s==null?void 0:s.email],queryFn:()=>se(s.email),enabled:!!(s!=null&&s.email)}),I=E({mutationFn:async({challengeId:a,data:r})=>await z(a,r),onSuccess:()=>{w.invalidateQueries({queryKey:["myTeamChallenges",s==null?void 0:s.email]})}}),D=E({mutationFn:async({stars:a,coins:r})=>{if(!(s!=null&&s.email))throw new Error("Not signed in");await Z(s.email,{coins:((s==null?void 0:s.coins)||0)+(r||0),total_stars_earned:((s==null?void 0:s.total_stars_earned)||0)+(a||0)})},onSuccess:(a,r)=>{w.invalidateQueries({queryKey:["currentUser"]}),k(`Claimed ${r.stars} stars and ${r.coins} coins!`),setTimeout(()=>k(null),3e3)}}),Q=a=>{const r=G.find(i=>i.email===a);return(r==null?void 0:r.child_name)||(r==null?void 0:r.full_name)||a.split("@")[0]},A=a=>{const r=new Date(a.start_date),i=a.end_date?new Date(a.end_date):new Date,n=q.filter(l=>{var t;const m=(t=l.completed_at)!=null&&t.toDate?l.completed_at.toDate():new Date,b=m>=r&&m<=i,h=a.specific_operation==="any"||l.operation===a.specific_operation,P=a.specific_level==="any"||l.level===a.specific_level;return b&&h&&P}),d=M.filter(l=>{const t=new Date(l.challenge_date);return t>=r&&t<=i});let c=0;switch(a.challenge_type){case"team_score":c=n.reduce((l,t)=>l+(t.score||0),0);break;case"combined_accuracy":if(n.length>0){const l=n.reduce((t,m)=>t+m.correct_answers/m.total_questions*100,0);c=Math.round(l/n.length)}break;case"total_games":c=n.length;break;case"total_stars":c=n.reduce((l,t)=>l+(t.stars_earned||0),0),c+=d.reduce((l,t)=>l+(t.bonus_stars||0),0);break;case"daily_streak_sum":c=d.length;break;case"speed_challenge":n.length>0&&(c=Math.min(...n.map(l=>l.time_taken)));break}return c};$.useEffect(()=>{!s||o.length===0||o.forEach(a=>{if(a.is_completed)return;const r=A(a),i=a.member_contributions||{};if(i[s.email]!==r){const n={...i,[s.email]:r};let d=0;if(a.challenge_type==="combined_accuracy"){const l=Object.values(n);l.length>0&&(d=Math.round(l.reduce((t,m)=>t+m,0)/l.length))}else if(a.challenge_type==="speed_challenge"){const l=Object.values(n).filter(t=>t>0);l.length>0&&(d=Math.min(...l))}else d=Object.values(n).reduce((l,t)=>l+t,0);const c=d>=a.target_value;I.mutate({challengeId:a.id,data:{member_contributions:n,current_value:d,is_completed:c}})}})},[q,M,o,s]);const O=a=>{D.mutate({stars:a.reward_stars||0,coins:a.reward_coins||0})},T=a=>({team_score:"Team Score Challenge",combined_accuracy:"Combined Accuracy Goal",total_games:"Total Games Challenge",total_stars:"Star Collection Challenge",daily_streak_sum:"Daily Challenge Streak",speed_challenge:"Speed Challenge"})[a]||a,S=a=>({team_score:g,combined_accuracy:re,total_games:te,total_stars:W,daily_streak_sum:B,speed_challenge:F})[a]||g,u=o.filter(a=>!a.is_completed),p=o.filter(a=>a.is_completed);return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-block mb-4",children:e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-xl",children:e.jsx(j,{className:"w-10 h-10 text-white"})})}),e.jsx("h1",{className:"text-4xl md:text-5xl font-bold mb-2 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent",children:"Team Challenges"}),e.jsx("p",{className:"text-xl text-gray-600",children:"Work together with friends and family!"})]}),C&&e.jsxs(_,{className:"mb-6 bg-green-50 border-green-200",children:[e.jsx(f,{className:"w-4 h-4 text-green-600"}),e.jsxs(y,{className:"text-green-800",children:[e.jsx("strong",{children:"Reward Claimed!"})," ",C," ðŸŽ‰"]})]}),o.length===0?e.jsx(N,{className:"border-2 border-gray-200",children:e.jsxs(v,{className:"p-12 text-center",children:[e.jsx(j,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"No Team Challenges Yet"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Ask your parent or teacher to create a team challenge for you and your friends!"}),e.jsx(_,{className:"bg-blue-50 border-blue-200 text-left",children:e.jsxs(y,{className:"text-blue-800",children:[e.jsx("strong",{children:"What are Team Challenges?"}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Work together with friends and family"}),e.jsx("li",{children:"Combine your progress to reach team goals"}),e.jsx("li",{children:"Earn bonus rewards when you succeed together"}),e.jsx("li",{children:"See everyone's contributions in real-time"})]})]})})]})}):e.jsxs("div",{className:"space-y-8",children:[u.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(g,{className:"w-6 h-6 text-purple-500"}),"Active Challenges (",u.length,")"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:u.map(a=>{var r,i,n;const d=S(a.challenge_type),c=Math.min(a.current_value/a.target_value*100,100);(r=a.member_contributions)!=null&&r[s==null?void 0:s.email];const l=a.end_date?Math.max(0,Math.ceil((new Date(a.end_date)-new Date)/(1e3*60*60*24))):null;return e.jsxs(N,{className:"border-2 border-purple-200 hover:shadow-lg transition-shadow",children:[e.jsx(K,{className:"bg-gradient-to-r from-purple-100 to-pink-100",children:e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(d,{className:"w-6 h-6 text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg",children:a.challenge_name}),l!==null&&e.jsxs(U,{variant:"outline",className:"bg-white",children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),l,"d left"]})]}),e.jsx("p",{className:"text-sm font-normal text-gray-600 mt-1",children:T(a.challenge_type)})]})]})}),e.jsxs(v,{className:"p-6 space-y-4",children:[a.description&&e.jsx("p",{className:"text-gray-600",children:a.description}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"font-medium",children:"Team Progress"}),e.jsxs("span",{className:"font-bold",children:[Math.round(a.current_value)," / ",a.target_value,a.challenge_type==="combined_accuracy"&&"%",a.challenge_type==="speed_challenge"&&"s"]})]}),e.jsx(le,{value:c,className:"h-3"})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-bold text-sm mb-3 flex items-center gap-2",children:[e.jsx(j,{className:"w-4 h-4 text-purple-500"}),"Team Members (",((i=a.team_members)==null?void 0:i.length)||0,")"]}),e.jsx("div",{className:"space-y-2",children:(n=a.team_members)==null?void 0:n.map(t=>{var m;const b=((m=a.member_contributions)==null?void 0:m[t])||0,h=t===(s==null?void 0:s.email);return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded-lg ${h?"bg-purple-50 border-2 border-purple-200":"bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:Q(t)}),h&&e.jsx(U,{className:"bg-purple-500 text-white text-xs",children:"You"})]}),e.jsxs("span",{className:"text-sm font-bold text-gray-700",children:[Math.round(b),a.challenge_type==="combined_accuracy"&&"%",a.challenge_type==="speed_challenge"&&"s"]})]},t)})})]}),e.jsxs("div",{className:"bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border-2 border-yellow-200",children:[e.jsxs("h4",{className:"font-bold text-sm mb-2 flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4 text-yellow-600"}),"Rewards on Completion"]}),e.jsxs("div",{className:"flex gap-3 text-sm",children:[a.reward_stars>0&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-yellow-600",children:[e.jsx(W,{className:"w-4 h-4 fill-yellow-400"}),a.reward_stars," stars"]}),a.reward_coins>0&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-blue-600",children:[e.jsx(H,{className:"w-4 h-4"}),a.reward_coins," coins"]})]})]})]})]},a.id)})})]}),p.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-green-500"}),"Completed Challenges (",p.length,")"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:p.map(a=>(S(a.challenge_type),e.jsxs(N,{className:"border-2 border-green-300 bg-green-50",children:[e.jsx(K,{className:"bg-gradient-to-r from-green-100 to-emerald-100",children:e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-green-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-lg",children:a.challenge_name}),e.jsx("p",{className:"text-sm font-normal text-gray-600 mt-1",children:T(a.challenge_type)})]})]})}),e.jsxs(v,{className:"p-6 space-y-4",children:[e.jsxs(_,{className:"bg-white border-green-200",children:[e.jsx(g,{className:"w-4 h-4 text-green-600"}),e.jsxs(y,{className:"text-green-800",children:[e.jsx("strong",{children:"Challenge Complete!"})," Your team achieved the goal together! ðŸŽ‰",a.reward_message&&e.jsx("p",{className:"mt-1",children:a.reward_message})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"Final Score:"}),e.jsxs("span",{className:"text-2xl font-bold text-green-600",children:[Math.round(a.current_value)," / ",a.target_value]})]}),e.jsxs(L,{onClick:()=>O(a),disabled:D.isPending,className:"w-full bg-gradient-to-r from-green-500 to-emerald-500",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Claim Rewards"]})]})]},a.id)))})]})]})]})}export{oe as default};
