import{u as I,E as $,a2 as B,a as x,x as e,c as j,N as _,C as f,A as y,h as N,m as v,e as u,K,G as V,H as Y,t as E,w as F,j as U,p as A,a4 as X,U as z,aV as J,aa as L,aQ as Z,a0 as ee,$ as se,ad as le}from"./index-KqSff4jF.js";import{D as P}from"./useMutation-Dw-sPjxD-CEUn9Yuu-xvhDPSZb.js";import{B as ae}from"./progress-DswiN-jt-CRkTvpyk-D1KYlrjl.js";import{n as te}from"./trending-up-DOxCo9I6-CjyZKRpy-BwiJPOic.js";import{y as re}from"./target-1p2ICMDN-CvDzxGjB-qkOcir94.js";function oe(){const w=I(),[C,k]=$.useState(null),{user:l}=B(),{data:G=[]}=x({queryKey:["allUsers"],queryFn:()=>Z(),staleTime:3e5}),{data:o=[]}=x({queryKey:["myTeamChallenges",l==null?void 0:l.email],queryFn:()=>ee(l.email),enabled:!!(l!=null&&l.email)}),{data:D=[]}=x({queryKey:["myProgress",l==null?void 0:l.email],queryFn:()=>se(l.email),enabled:!!(l!=null&&l.email)}),{data:q=[]}=x({queryKey:["myDailyChallenges",l==null?void 0:l.email],queryFn:()=>le(l.email),enabled:!!(l!=null&&l.email)}),O=P({mutationFn:async({challengeId:s,data:r})=>await J(s,r),onSuccess:()=>{w.invalidateQueries({queryKey:["myTeamChallenges",l==null?void 0:l.email]})}}),M=P({mutationFn:async({stars:s,coins:r})=>{if(!(l!=null&&l.email))throw new Error("Not signed in");await L(l.email,{coins:((l==null?void 0:l.coins)||0)+(r||0),total_stars_earned:((l==null?void 0:l.total_stars_earned)||0)+(s||0)})},onSuccess:(s,r)=>{w.invalidateQueries({queryKey:["currentUser"]}),k(`Claimed ${r.stars} stars and ${r.coins} coins!`),setTimeout(()=>k(null),3e3)}}),Q=s=>{const r=G.find(i=>i.email===s);return(r==null?void 0:r.child_name)||(r==null?void 0:r.full_name)||s.split("@")[0]},W=s=>{const r=new Date(s.start_date),i=s.end_date?new Date(s.end_date):new Date,n=D.filter(a=>{var t;const m=(t=a.completed_at)!=null&&t.toDate?a.completed_at.toDate():new Date,b=m>=r&&m<=i,h=s.specific_operation==="any"||a.operation===s.specific_operation,H=s.specific_level==="any"||a.level===s.specific_level;return b&&h&&H}),d=q.filter(a=>{const t=new Date(a.challenge_date);return t>=r&&t<=i});let c=0;switch(s.challenge_type){case"team_score":c=n.reduce((a,t)=>a+(t.score||0),0);break;case"combined_accuracy":if(n.length>0){const a=n.reduce((t,m)=>t+m.correct_answers/m.total_questions*100,0);c=Math.round(a/n.length)}break;case"total_games":c=n.length;break;case"total_stars":c=n.reduce((a,t)=>a+(t.stars_earned||0),0),c+=d.reduce((a,t)=>a+(t.bonus_stars||0),0);break;case"daily_streak_sum":c=d.length;break;case"speed_challenge":n.length>0&&(c=Math.min(...n.map(a=>a.time_taken)));break}return c};$.useEffect(()=>{!l||o.length===0||o.forEach(s=>{if(s.is_completed)return;const r=W(s),i=s.member_contributions||{};if(i[l.email]!==r){const n={...i,[l.email]:r};let d=0;if(s.challenge_type==="combined_accuracy"){const a=Object.values(n);a.length>0&&(d=Math.round(a.reduce((t,m)=>t+m,0)/a.length))}else if(s.challenge_type==="speed_challenge"){const a=Object.values(n).filter(t=>t>0);a.length>0&&(d=Math.min(...a))}else d=Object.values(n).reduce((a,t)=>a+t,0);const c=d>=s.target_value;O.mutate({challengeId:s.id,data:{member_contributions:n,current_value:d,is_completed:c}})}})},[D,q,o,l]);const R=s=>{M.mutate({stars:s.reward_stars||0,coins:s.reward_coins||0})},T=s=>({team_score:"Team Score Challenge",combined_accuracy:"Combined Accuracy Goal",total_games:"Total Games Challenge",total_stars:"Star Collection Challenge",daily_streak_sum:"Daily Challenge Streak",speed_challenge:"Speed Challenge"})[s]||s,S=s=>({team_score:u,combined_accuracy:re,total_games:te,total_stars:Y,daily_streak_sum:V,speed_challenge:K})[s]||u,g=o.filter(s=>!s.is_completed),p=o.filter(s=>s.is_completed);return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-block mb-4",children:e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-xl",children:e.jsx(j,{className:"w-10 h-10 text-white"})})}),e.jsx("h1",{className:"text-4xl md:text-5xl font-bold mb-2 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent",children:"Team Challenges"}),e.jsx("p",{className:"text-xl text-gray-600",children:"Work together with friends and family!"})]}),C&&e.jsxs(_,{className:"mb-6 bg-green-50 border-green-200",children:[e.jsx(f,{className:"w-4 h-4 text-green-600"}),e.jsxs(y,{className:"text-green-800",children:[e.jsx("strong",{children:"Reward Claimed!"})," ",C," ðŸŽ‰"]})]}),o.length===0?e.jsx(N,{className:"border-2 border-gray-200",children:e.jsxs(v,{className:"p-12 text-center",children:[e.jsx(j,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"No Team Challenges Yet"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Ask your parent or teacher to create a team challenge for you and your friends!"}),e.jsx(_,{className:"bg-blue-50 border-blue-200 text-left",children:e.jsxs(y,{className:"text-blue-800",children:[e.jsx("strong",{children:"What are Team Challenges?"}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Work together with friends and family"}),e.jsx("li",{children:"Combine your progress to reach team goals"}),e.jsx("li",{children:"Earn bonus rewards when you succeed together"}),e.jsx("li",{children:"See everyone's contributions in real-time"})]})]})})]})}):e.jsxs("div",{className:"space-y-8",children:[g.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(u,{className:"w-6 h-6 text-purple-500"}),"Active Challenges (",g.length,")"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:g.map(s=>{var r,i,n;const d=S(s.challenge_type),c=Math.min(s.current_value/s.target_value*100,100);(r=s.member_contributions)!=null&&r[l==null?void 0:l.email];const a=s.end_date?Math.max(0,Math.ceil((new Date(s.end_date)-new Date)/(1e3*60*60*24))):null;return e.jsxs(N,{className:"border-2 border-purple-200 hover:shadow-lg transition-shadow",children:[e.jsx(E,{className:"bg-gradient-to-r from-purple-100 to-pink-100",children:e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(d,{className:"w-6 h-6 text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg",children:s.challenge_name}),a!==null&&e.jsxs(U,{variant:"outline",className:"bg-white",children:[e.jsx(K,{className:"w-3 h-3 mr-1"}),a,"d left"]})]}),e.jsx("p",{className:"text-sm font-normal text-gray-600 mt-1",children:T(s.challenge_type)})]})]})}),e.jsxs(v,{className:"p-6 space-y-4",children:[s.description&&e.jsx("p",{className:"text-gray-600",children:s.description}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"font-medium",children:"Team Progress"}),e.jsxs("span",{className:"font-bold",children:[Math.round(s.current_value)," / ",s.target_value,s.challenge_type==="combined_accuracy"&&"%",s.challenge_type==="speed_challenge"&&"s"]})]}),e.jsx(ae,{value:c,className:"h-3"})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-bold text-sm mb-3 flex items-center gap-2",children:[e.jsx(j,{className:"w-4 h-4 text-purple-500"}),"Team Members (",((i=s.team_members)==null?void 0:i.length)||0,")"]}),e.jsx("div",{className:"space-y-2",children:(n=s.team_members)==null?void 0:n.map(t=>{var m;const b=((m=s.member_contributions)==null?void 0:m[t])||0,h=t===(l==null?void 0:l.email);return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded-lg ${h?"bg-purple-50 border-2 border-purple-200":"bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:Q(t)}),h&&e.jsx(U,{className:"bg-purple-500 text-white text-xs",children:"You"})]}),e.jsxs("span",{className:"text-sm font-bold text-gray-700",children:[Math.round(b),s.challenge_type==="combined_accuracy"&&"%",s.challenge_type==="speed_challenge"&&"s"]})]},t)})})]}),e.jsxs("div",{className:"bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border-2 border-yellow-200",children:[e.jsxs("h4",{className:"font-bold text-sm mb-2 flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-yellow-600"}),"Rewards on Completion"]}),e.jsxs("div",{className:"flex gap-3 text-sm",children:[s.reward_stars>0&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-yellow-600",children:[e.jsx(Y,{className:"w-4 h-4 fill-yellow-400"}),s.reward_stars," stars"]}),s.reward_coins>0&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-blue-600",children:[e.jsx(X,{className:"w-4 h-4"}),s.reward_coins," coins"]})]})]})]})]},s.id)})})]}),p.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-green-500"}),"Completed Challenges (",p.length,")"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:p.map(s=>(S(s.challenge_type),e.jsxs(N,{className:"border-2 border-green-300 bg-green-50",children:[e.jsx(E,{className:"bg-gradient-to-r from-green-100 to-emerald-100",children:e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-green-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-lg",children:s.challenge_name}),e.jsx("p",{className:"text-sm font-normal text-gray-600 mt-1",children:T(s.challenge_type)})]})]})}),e.jsxs(v,{className:"p-6 space-y-4",children:[e.jsxs(_,{className:"bg-white border-green-200",children:[e.jsx(u,{className:"w-4 h-4 text-green-600"}),e.jsxs(y,{className:"text-green-800",children:[e.jsx("strong",{children:"Challenge Complete!"})," Your team achieved the goal together! ðŸŽ‰",s.reward_message&&e.jsx("p",{className:"mt-1",children:s.reward_message})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"Final Score:"}),e.jsxs("span",{className:"text-2xl font-bold text-green-600",children:[Math.round(s.current_value)," / ",s.target_value]})]}),e.jsxs(z,{onClick:()=>R(s),disabled:M.isPending,className:"w-full bg-gradient-to-r from-green-500 to-emerald-500",children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"Claim Rewards"]})]})]},s.id)))})]})]})]})}export{oe as default};
