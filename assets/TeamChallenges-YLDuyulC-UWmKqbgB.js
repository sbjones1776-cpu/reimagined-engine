import{s as W,T as E,a2 as V,y as x,x as e,c as j,S as _,D as f,A as y,o as N,u as w,E as u,e as F,q as L,G as $,r as A,v as K,R as G,I,a4 as z,a as B,aV as H,aa as J,aQ as Z,a0 as ee,Y as ae,ad as le}from"./index-C_0kN0Kc.js";import{Q as R}from"./useMutation-Dw-sPjxD-CEUn9Yuu.js";import{F as se}from"./progress-DswiN-jt-CRkTvpyk.js";import{i as te}from"./trending-up-DOxCo9I6-CjyZKRpy.js";import{o as re}from"./target-1p2ICMDN-CvDzxGjB.js";function oe(){const v=W(),[C,k]=E.useState(null),{user:l}=V(),{data:Y=[]}=x({queryKey:["allUsers"],queryFn:()=>Z(),staleTime:3e5}),{data:o=[]}=x({queryKey:["myTeamChallenges",l==null?void 0:l.email],queryFn:()=>ee(l.email),enabled:!!(l!=null&&l.email)}),{data:q=[]}=x({queryKey:["myProgress",l==null?void 0:l.email],queryFn:()=>ae(l.email),enabled:!!(l!=null&&l.email)}),{data:T=[]}=x({queryKey:["myDailyChallenges",l==null?void 0:l.email],queryFn:()=>le(l.email),enabled:!!(l!=null&&l.email)}),P=R({mutationFn:async({challengeId:a,data:r})=>await H(a,r),onSuccess:()=>{v.invalidateQueries({queryKey:["myTeamChallenges",l==null?void 0:l.email]})}}),D=R({mutationFn:async({stars:a,coins:r})=>{if(!(l!=null&&l.email))throw new Error("Not signed in");await J(l.email,{coins:((l==null?void 0:l.coins)||0)+(r||0),total_stars_earned:((l==null?void 0:l.total_stars_earned)||0)+(a||0)})},onSuccess:(a,r)=>{v.invalidateQueries({queryKey:["currentUser"]}),k(`Claimed ${r.stars} stars and ${r.coins} coins!`),setTimeout(()=>k(null),3e3)}}),Q=a=>{const r=Y.find(i=>i.email===a);return(r==null?void 0:r.child_name)||(r==null?void 0:r.full_name)||a.split("@")[0]},X=a=>{const r=new Date(a.start_date),i=a.end_date?new Date(a.end_date):new Date,n=q.filter(s=>{var t;const m=(t=s.completed_at)!=null&&t.toDate?s.completed_at.toDate():new Date,b=m>=r&&m<=i,h=a.specific_operation==="any"||s.operation===a.specific_operation,U=a.specific_level==="any"||s.level===a.specific_level;return b&&h&&U}),d=T.filter(s=>{const t=new Date(s.challenge_date);return t>=r&&t<=i});let c=0;switch(a.challenge_type){case"team_score":c=n.reduce((s,t)=>s+(t.score||0),0);break;case"combined_accuracy":if(n.length>0){const s=n.reduce((t,m)=>t+m.correct_answers/m.total_questions*100,0);c=Math.round(s/n.length)}break;case"total_games":c=n.length;break;case"total_stars":c=n.reduce((s,t)=>s+(t.stars_earned||0),0),c+=d.reduce((s,t)=>s+(t.bonus_stars||0),0);break;case"daily_streak_sum":c=d.length;break;case"speed_challenge":n.length>0&&(c=Math.min(...n.map(s=>s.time_taken)));break}return c};E.useEffect(()=>{!l||o.length===0||o.forEach(a=>{if(a.is_completed)return;const r=X(a),i=a.member_contributions||{};if(i[l.email]!==r){const n={...i,[l.email]:r};let d=0;if(a.challenge_type==="combined_accuracy"){const s=Object.values(n);s.length>0&&(d=Math.round(s.reduce((t,m)=>t+m,0)/s.length))}else if(a.challenge_type==="speed_challenge"){const s=Object.values(n).filter(t=>t>0);s.length>0&&(d=Math.min(...s))}else d=Object.values(n).reduce((s,t)=>s+t,0);const c=d>=a.target_value;P.mutate({challengeId:a.id,data:{member_contributions:n,current_value:d,is_completed:c}})}})},[q,T,o,l]);const O=a=>{D.mutate({stars:a.reward_stars||0,coins:a.reward_coins||0})},M=a=>({team_score:"Team Score Challenge",combined_accuracy:"Combined Accuracy Goal",total_games:"Total Games Challenge",total_stars:"Star Collection Challenge",daily_streak_sum:"Daily Challenge Streak",speed_challenge:"Speed Challenge"})[a]||a,S=a=>({team_score:u,combined_accuracy:re,total_games:te,total_stars:$,daily_streak_sum:L,speed_challenge:F})[a]||u,g=o.filter(a=>!a.is_completed),p=o.filter(a=>a.is_completed);return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-block mb-4",children:e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-xl",children:e.jsx(j,{className:"w-10 h-10 text-white"})})}),e.jsx("h1",{className:"text-4xl md:text-5xl font-bold mb-2 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent",children:"Team Challenges"}),e.jsx("p",{className:"text-xl text-gray-600",children:"Work together with friends and family!"})]}),C&&e.jsxs(_,{className:"mb-6 bg-green-50 border-green-200",children:[e.jsx(f,{className:"w-4 h-4 text-green-600"}),e.jsxs(y,{className:"text-green-800",children:[e.jsx("strong",{children:"Reward Claimed!"})," ",C," ðŸŽ‰"]})]}),o.length===0?e.jsx(N,{className:"border-2 border-gray-200",children:e.jsxs(w,{className:"p-12 text-center",children:[e.jsx(j,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"No Team Challenges Yet"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Ask your parent or teacher to create a team challenge for you and your friends!"}),e.jsx(_,{className:"bg-blue-50 border-blue-200 text-left",children:e.jsxs(y,{className:"text-blue-800",children:[e.jsx("strong",{children:"What are Team Challenges?"}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Work together with friends and family"}),e.jsx("li",{children:"Combine your progress to reach team goals"}),e.jsx("li",{children:"Earn bonus rewards when you succeed together"}),e.jsx("li",{children:"See everyone's contributions in real-time"})]})]})})]})}):e.jsxs("div",{className:"space-y-8",children:[g.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(u,{className:"w-6 h-6 text-purple-500"}),"Active Challenges (",g.length,")"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:g.map(a=>{var r,i,n;const d=S(a.challenge_type),c=Math.min(a.current_value/a.target_value*100,100);(r=a.member_contributions)!=null&&r[l==null?void 0:l.email];const s=a.end_date?Math.max(0,Math.ceil((new Date(a.end_date)-new Date)/(1e3*60*60*24))):null;return e.jsxs(N,{className:"border-2 border-purple-200 hover:shadow-lg transition-shadow",children:[e.jsx(A,{className:"bg-gradient-to-r from-purple-100 to-pink-100",children:e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(d,{className:"w-6 h-6 text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg",children:a.challenge_name}),s!==null&&e.jsxs(G,{variant:"outline",className:"bg-white",children:[e.jsx(F,{className:"w-3 h-3 mr-1"}),s,"d left"]})]}),e.jsx("p",{className:"text-sm font-normal text-gray-600 mt-1",children:M(a.challenge_type)})]})]})}),e.jsxs(w,{className:"p-6 space-y-4",children:[a.description&&e.jsx("p",{className:"text-gray-600",children:a.description}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"font-medium",children:"Team Progress"}),e.jsxs("span",{className:"font-bold",children:[Math.round(a.current_value)," / ",a.target_value,a.challenge_type==="combined_accuracy"&&"%",a.challenge_type==="speed_challenge"&&"s"]})]}),e.jsx(se,{value:c,className:"h-3"})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-bold text-sm mb-3 flex items-center gap-2",children:[e.jsx(j,{className:"w-4 h-4 text-purple-500"}),"Team Members (",((i=a.team_members)==null?void 0:i.length)||0,")"]}),e.jsx("div",{className:"space-y-2",children:(n=a.team_members)==null?void 0:n.map(t=>{var m;const b=((m=a.member_contributions)==null?void 0:m[t])||0,h=t===(l==null?void 0:l.email);return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded-lg ${h?"bg-purple-50 border-2 border-purple-200":"bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:Q(t)}),h&&e.jsx(G,{className:"bg-purple-500 text-white text-xs",children:"You"})]}),e.jsxs("span",{className:"text-sm font-bold text-gray-700",children:[Math.round(b),a.challenge_type==="combined_accuracy"&&"%",a.challenge_type==="speed_challenge"&&"s"]})]},t)})})]}),e.jsxs("div",{className:"bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border-2 border-yellow-200",children:[e.jsxs("h4",{className:"font-bold text-sm mb-2 flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4 text-yellow-600"}),"Rewards on Completion"]}),e.jsxs("div",{className:"flex gap-3 text-sm",children:[a.reward_stars>0&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-yellow-600",children:[e.jsx($,{className:"w-4 h-4 fill-yellow-400"}),a.reward_stars," stars"]}),a.reward_coins>0&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-blue-600",children:[e.jsx(z,{className:"w-4 h-4"}),a.reward_coins," coins"]})]})]})]})]},a.id)})})]}),p.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-green-500"}),"Completed Challenges (",p.length,")"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:p.map(a=>(S(a.challenge_type),e.jsxs(N,{className:"border-2 border-green-300 bg-green-50",children:[e.jsx(A,{className:"bg-gradient-to-r from-green-100 to-emerald-100",children:e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-green-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-lg",children:a.challenge_name}),e.jsx("p",{className:"text-sm font-normal text-gray-600 mt-1",children:M(a.challenge_type)})]})]})}),e.jsxs(w,{className:"p-6 space-y-4",children:[e.jsxs(_,{className:"bg-white border-green-200",children:[e.jsx(u,{className:"w-4 h-4 text-green-600"}),e.jsxs(y,{className:"text-green-800",children:[e.jsx("strong",{children:"Challenge Complete!"})," Your team achieved the goal together! ðŸŽ‰",a.reward_message&&e.jsx("p",{className:"mt-1",children:a.reward_message})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"Final Score:"}),e.jsxs("span",{className:"text-2xl font-bold text-green-600",children:[Math.round(a.current_value)," / ",a.target_value]})]}),e.jsxs(B,{onClick:()=>O(a),disabled:D.isPending,className:"w-full bg-gradient-to-r from-green-500 to-emerald-500",children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Claim Rewards"]})]})]},a.id)))})]})]})]})}export{oe as default};
