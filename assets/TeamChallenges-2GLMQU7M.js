import{z as W,r as A,Z as Y,u,j as e,U as j,A as y,b as f,y as _,C as N,d as w,T as g,I as P,J as F,B as K,e as R,x as B,h as H,aG as z,$ as J,a as Z,aB as V,M as X,K as ee,aH as se}from"./index-C0XnwW1J.js";import{u as G}from"./useMutation-BBbn5Ibo.js";import{P as ae}from"./progress-D8Mly-oi.js";import{A as I}from"./award-DsC9STJ2.js";import{C as te}from"./coins-C3lSgozT.js";import{T as re}from"./trending-up-Bw7UHNpS.js";import{T as le}from"./target-CKjL3a7Z.js";function he(){const C=W(),[v,T]=A.useState(null),{user:a}=Y(),{data:O=[]}=u({queryKey:["allUsers"],queryFn:()=>V(),staleTime:3e5}),{data:m=[]}=u({queryKey:["myTeamChallenges",a==null?void 0:a.email],queryFn:()=>X(a.email),enabled:!!(a!=null&&a.email)}),{data:k=[]}=u({queryKey:["myProgress",a==null?void 0:a.email],queryFn:()=>ee(a.email),enabled:!!(a!=null&&a.email)}),{data:D=[]}=u({queryKey:["myDailyChallenges",a==null?void 0:a.email],queryFn:()=>se(a.email),enabled:!!(a!=null&&a.email)}),Q=G({mutationFn:async({challengeId:s,data:l})=>await z(s,l),onSuccess:()=>{C.invalidateQueries({queryKey:["myTeamChallenges",a==null?void 0:a.email]})}}),M=G({mutationFn:async({stars:s,coins:l})=>{if(!(a!=null&&a.email))throw new Error("Not signed in");await J(a.email,{coins:((a==null?void 0:a.coins)||0)+(l||0),total_stars_earned:((a==null?void 0:a.total_stars_earned)||0)+(s||0)})},onSuccess:(s,l)=>{C.invalidateQueries({queryKey:["currentUser"]}),T(`Claimed ${l.stars} stars and ${l.coins} coins!`),setTimeout(()=>T(null),3e3)}}),$=s=>{const l=O.find(o=>o.email===s);return(l==null?void 0:l.child_name)||(l==null?void 0:l.full_name)||s.split("@")[0]},E=s=>{const l=new Date(s.start_date),o=s.end_date?new Date(s.end_date):new Date,n=k.filter(t=>{var S;const r=(S=t.completed_at)!=null&&S.toDate?t.completed_at.toDate():new Date,d=r>=l&&r<=o,x=s.specific_operation==="any"||t.operation===s.specific_operation,h=s.specific_level==="any"||t.level===s.specific_level;return d&&x&&h}),c=D.filter(t=>{const r=new Date(t.challenge_date);return r>=l&&r<=o});let i=0;switch(s.challenge_type){case"team_score":i=n.reduce((t,r)=>t+(r.score||0),0);break;case"combined_accuracy":if(n.length>0){const t=n.reduce((r,d)=>r+d.correct_answers/d.total_questions*100,0);i=Math.round(t/n.length)}break;case"total_games":i=n.length;break;case"total_stars":i=n.reduce((t,r)=>t+(r.stars_earned||0),0),i+=c.reduce((t,r)=>t+(r.bonus_stars||0),0);break;case"daily_streak_sum":i=c.length;break;case"speed_challenge":n.length>0&&(i=Math.min(...n.map(t=>t.time_taken)));break}return i};A.useEffect(()=>{!a||m.length===0||m.forEach(s=>{if(s.is_completed)return;const l=E(s),o=s.member_contributions||{};if(o[a.email]!==l){const n={...o,[a.email]:l};let c=0;if(s.challenge_type==="combined_accuracy"){const t=Object.values(n);t.length>0&&(c=Math.round(t.reduce((r,d)=>r+d,0)/t.length))}else if(s.challenge_type==="speed_challenge"){const t=Object.values(n).filter(r=>r>0);t.length>0&&(c=Math.min(...t))}else c=Object.values(n).reduce((t,r)=>t+r,0);const i=c>=s.target_value;Q.mutate({challengeId:s.id,data:{member_contributions:n,current_value:c,is_completed:i}})}})},[k,D,m,a]);const L=s=>{M.mutate({stars:s.reward_stars||0,coins:s.reward_coins||0})},U=s=>({team_score:"Team Score Challenge",combined_accuracy:"Combined Accuracy Goal",total_games:"Total Games Challenge",total_stars:"Star Collection Challenge",daily_streak_sum:"Daily Challenge Streak",speed_challenge:"Speed Challenge"})[s]||s,q=s=>({team_score:g,combined_accuracy:le,total_games:re,total_stars:B,daily_streak_sum:Z,speed_challenge:R})[s]||g,p=m.filter(s=>!s.is_completed),b=m.filter(s=>s.is_completed);return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"inline-block mb-4",children:e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center shadow-xl",children:e.jsx(j,{className:"w-10 h-10 text-white"})})}),e.jsx("h1",{className:"text-4xl md:text-5xl font-bold mb-2 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent",children:"Team Challenges"}),e.jsx("p",{className:"text-xl text-gray-600",children:"Work together with friends and family!"})]}),v&&e.jsxs(y,{className:"mb-6 bg-green-50 border-green-200",children:[e.jsx(f,{className:"w-4 h-4 text-green-600"}),e.jsxs(_,{className:"text-green-800",children:[e.jsx("strong",{children:"Reward Claimed!"})," ",v," ðŸŽ‰"]})]}),m.length===0?e.jsx(N,{className:"border-2 border-gray-200",children:e.jsxs(w,{className:"p-12 text-center",children:[e.jsx(j,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"No Team Challenges Yet"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Ask your parent or teacher to create a team challenge for you and your friends!"}),e.jsx(y,{className:"bg-blue-50 border-blue-200 text-left",children:e.jsxs(_,{className:"text-blue-800",children:[e.jsx("strong",{children:"What are Team Challenges?"}),e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"Work together with friends and family"}),e.jsx("li",{children:"Combine your progress to reach team goals"}),e.jsx("li",{children:"Earn bonus rewards when you succeed together"}),e.jsx("li",{children:"See everyone's contributions in real-time"})]})]})})]})}):e.jsxs("div",{className:"space-y-8",children:[p.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(g,{className:"w-6 h-6 text-purple-500"}),"Active Challenges (",p.length,")"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:p.map(s=>{var c,i,t;const l=q(s.challenge_type),o=Math.min(s.current_value/s.target_value*100,100);(c=s.member_contributions)!=null&&c[a==null?void 0:a.email];const n=s.end_date?Math.max(0,Math.ceil((new Date(s.end_date)-new Date)/(1e3*60*60*24))):null;return e.jsxs(N,{className:"border-2 border-purple-200 hover:shadow-lg transition-shadow",children:[e.jsx(P,{className:"bg-gradient-to-r from-purple-100 to-pink-100",children:e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(l,{className:"w-6 h-6 text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-lg",children:s.challenge_name}),n!==null&&e.jsxs(K,{variant:"outline",className:"bg-white",children:[e.jsx(R,{className:"w-3 h-3 mr-1"}),n,"d left"]})]}),e.jsx("p",{className:"text-sm font-normal text-gray-600 mt-1",children:U(s.challenge_type)})]})]})}),e.jsxs(w,{className:"p-6 space-y-4",children:[s.description&&e.jsx("p",{className:"text-gray-600",children:s.description}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"font-medium",children:"Team Progress"}),e.jsxs("span",{className:"font-bold",children:[Math.round(s.current_value)," / ",s.target_value,s.challenge_type==="combined_accuracy"&&"%",s.challenge_type==="speed_challenge"&&"s"]})]}),e.jsx(ae,{value:o,className:"h-3"})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-bold text-sm mb-3 flex items-center gap-2",children:[e.jsx(j,{className:"w-4 h-4 text-purple-500"}),"Team Members (",((i=s.team_members)==null?void 0:i.length)||0,")"]}),e.jsx("div",{className:"space-y-2",children:(t=s.team_members)==null?void 0:t.map(r=>{var h;const d=((h=s.member_contributions)==null?void 0:h[r])||0,x=r===(a==null?void 0:a.email);return e.jsxs("div",{className:`flex items-center justify-between p-2 rounded-lg ${x?"bg-purple-50 border-2 border-purple-200":"bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:$(r)}),x&&e.jsx(K,{className:"bg-purple-500 text-white text-xs",children:"You"})]}),e.jsxs("span",{className:"text-sm font-bold text-gray-700",children:[Math.round(d),s.challenge_type==="combined_accuracy"&&"%",s.challenge_type==="speed_challenge"&&"s"]})]},r)})})]}),e.jsxs("div",{className:"bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border-2 border-yellow-200",children:[e.jsxs("h4",{className:"font-bold text-sm mb-2 flex items-center gap-2",children:[e.jsx(I,{className:"w-4 h-4 text-yellow-600"}),"Rewards on Completion"]}),e.jsxs("div",{className:"flex gap-3 text-sm",children:[s.reward_stars>0&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-yellow-600",children:[e.jsx(B,{className:"w-4 h-4 fill-yellow-400"}),s.reward_stars," stars"]}),s.reward_coins>0&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-blue-600",children:[e.jsx(te,{className:"w-4 h-4"}),s.reward_coins," coins"]})]})]})]})]},s.id)})})]}),b.length>0&&e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-green-500"}),"Completed Challenges (",b.length,")"]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6",children:b.map(s=>(q(s.challenge_type),e.jsxs(N,{className:"border-2 border-green-300 bg-green-50",children:[e.jsx(P,{className:"bg-gradient-to-r from-green-100 to-emerald-100",children:e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(f,{className:"w-6 h-6 text-green-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-lg",children:s.challenge_name}),e.jsx("p",{className:"text-sm font-normal text-gray-600 mt-1",children:U(s.challenge_type)})]})]})}),e.jsxs(w,{className:"p-6 space-y-4",children:[e.jsxs(y,{className:"bg-white border-green-200",children:[e.jsx(g,{className:"w-4 h-4 text-green-600"}),e.jsxs(_,{className:"text-green-800",children:[e.jsx("strong",{children:"Challenge Complete!"})," Your team achieved the goal together! ðŸŽ‰",s.reward_message&&e.jsx("p",{className:"mt-1",children:s.reward_message})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:"Final Score:"}),e.jsxs("span",{className:"text-2xl font-bold text-green-600",children:[Math.round(s.current_value)," / ",s.target_value]})]}),e.jsxs(H,{onClick:()=>L(s),disabled:M.isPending,className:"w-full bg-gradient-to-r from-green-500 to-emerald-500",children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Claim Rewards"]})]})]},s.id)))})]})]})]})}export{he as default};
